name: Build LEGO Island APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout source
      uses: actions/checkout@v3

    - name: üß∞ Install build dependencies
      run: sudo apt-get update && sudo apt-get install -y ninja-build

    - name: üì¶ Set up Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b

    - name: üß± Clone SDL3
      run: git clone --depth=1 --branch main https://github.com/libsdl-org/SDL SDL3

    - name: üìÇ Inject source + SDL3 into build
      run: |
        mkdir -p SDL3/android-project/app/jni/app/src/SDL3
        cp -r SDL3/* SDL3/android-project/app/jni/app/src/SDL3/
        mkdir -p SDL3/android-project/app/jni/app/src/isle
        cp -r . SDL3/android-project/app/jni/app/src/isle/

    - name: üìù Write custom Android.mk
      run: |
        cat << 'EOF' > SDL3/android-project/app/jni/Android.mk
        LOCAL_PATH := $(call my-dir)

        # SDL3 static library
        include $(CLEAR_VARS)
        LOCAL_MODULE := SDL3
        SDL3_SRC := $(wildcard $(LOCAL_PATH)/app/src/SDL3/src/*.c)
        LOCAL_SRC_FILES := $(SDL3_SRC:$(LOCAL_PATH)/%=%)
        LOCAL_C_INCLUDES := $(LOCAL_PATH)/app/src/SDL3/include
        LOCAL_CFLAGS := -DUSING_SDL3
        include $(BUILD_STATIC_LIBRARY)

        # Your game
        include $(CLEAR_VARS)
        LOCAL_MODULE := main
        GAME_SRC := $(wildcard $(LOCAL_PATH)/app/src/isle/*.cpp)
        LOCAL_SRC_FILES := $(GAME_SRC:$(LOCAL_PATH)/%=%)
        LOCAL_C_INCLUDES := \
            $(LOCAL_PATH)/app/src/SDL3/include \
            $(LOCAL_PATH)/app/src/isle
        LOCAL_STATIC_LIBRARIES := SDL3
        include $(BUILD_SHARED_LIBRARY)
        EOF

    - name: üìù Write Application.mk
      run: |
        cat << 'EOF' > SDL3/android-project/app/jni/Application.mk
        APP_ABI := arm64-v8a
        APP_PLATFORM := android-21
        APP_STL := c++_static
        EOF

    - name: üì≤ Build APK
      run: |
        cd SDL3/android-project
        ./gradlew assembleDebug

    - name: üì§ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: isle-portable.apk
        path: SDL3/android-project/app/build/outputs/apk/debug/app-debug.apk
